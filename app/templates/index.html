<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FleetDash</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/img/logo.png">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Config & Styles -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' },
                        brand: { 500: '#3b82f6', 600: '#2563eb' }
                    }
                }
            }
        }
    </script>
    <style>
        :root { --glass-border: rgba(255, 255, 255, 0.08); --glass-bg: rgba(30, 41, 59, 0.7); }
        body { background: #0f172a; background-image: radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%); background-attachment: fixed; }
        
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px; }
        
        .sidebar-link { transition: all 0.2s; border-radius: 10px; cursor: pointer; display: none; /* Hidden by default */ }
        .sidebar-link.visible { display: flex; } /* Shown via JS */
        .sidebar-link:hover, .sidebar-link.active { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-up { animation: fadeUp 0.4s ease-out forwards; }
        .delay-1 { animation-delay: 0.1s; } .delay-2 { animation-delay: 0.2s; }
        
        select, input { color-scheme: dark; }
    </style>
</head>
<body class="text-slate-200 antialiased overflow-hidden">

    <div class="flex h-screen w-full">
        
        <!-- SIDEBAR -->
        <aside class="hidden md:flex w-64 flex-col glass-panel m-3 ml-0 md:ml-3 h-[calc(100vh-24px)]">
            <!-- Brand -->
            <div class="p-6 flex items-center gap-3 border-b border-white/5">
                <!-- Desktop Logo -->
                <img src="/static/img/logo.png" alt="Logo" class="w-8 h-8 rounded-lg shadow-lg shadow-blue-500/30 object-contain bg-white">
                <h1 class="font-bold text-lg tracking-tight">FleetDash</h1>
            </div>

            <!-- Nav -->
            <nav class="flex-1 px-3 py-6 space-y-1 overflow-y-auto">
                
                <!-- SECTION: OVERVIEW -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 nav-group" id="group-overview">Overview</p>
                
                <a href="#dashboard" class="sidebar-link items-center gap-3 px-3 py-2.5 text-sm font-medium" id="nav-dashboard">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> Dashboard
                </a>
                <a href="#analytics" class="sidebar-link items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-slate-200" id="nav-analytics">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i> Analytics
                </a>

                <!-- SECTION: MANAGEMENT -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2 nav-group" id="group-management">Management</p>
                
                <a href="#vehicles" class="sidebar-link items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-slate-200" id="nav-vehicles">
                    <i data-lucide="car" class="w-5 h-5"></i> Vehicles
                </a>
                <a href="#requests" class="sidebar-link items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-slate-200" id="nav-requests">
                    <i data-lucide="file-check" class="w-5 h-5"></i> Requests
                </a>
                <a href="#users" class="sidebar-link items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-slate-200" id="nav-users">
                    <i data-lucide="users" class="w-5 h-5"></i> Users
                </a>
                <a href="#fuel" class="sidebar-link items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-slate-200" id="nav-fuel">
                    <i data-lucide="fuel" class="w-5 h-5"></i> Fuel Logs
                </a>

                <!-- SECTION: OPERATIONS -->
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-6 mb-2 nav-group" id="group-operations">Operations</p>
                
                <a href="#maintenance" class="sidebar-link items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-slate-200" id="nav-maintenance">
                    <i data-lucide="wrench" class="w-5 h-5"></i> Maintenance
                </a>
                <a href="#panne" class="sidebar-link items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-slate-200" id="nav-panne">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i> Panne
                </a>
                <a href="#reparations" class="sidebar-link items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:text-slate-200" id="nav-reparations">
                    <i data-lucide="hammer" class="w-5 h-5"></i> Reparations
                </a>
                
            </nav>

            <!-- User Profile (Bottom) -->
            <div class="p-4 border-t border-white/5">
                <div class="flex items-center gap-3 p-2 rounded-xl hover:bg-white/5 cursor-pointer transition">
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-300 font-bold" id="user-avatar">U</div>
                    <div class="flex-1 overflow-hidden">
                        <p class="text-sm font-medium truncate" id="user-name">Loading...</p>
                        <p class="text-xs text-slate-500 truncate" id="user-role">...</p>
                    </div>
                    <button onclick="logout()" class="text-slate-400 hover:text-red-400 transition" title="Sign Out"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 h-full overflow-y-auto overflow-x-hidden p-4 md:p-6 scroll-smooth">
            
            <!-- Mobile Header -->
            <header class="flex md:hidden items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <!-- Mobile Logo (UPDATED HERE) -->
                    <img src="/static/img/logo.png" alt="Logo" class="w-8 h-8 rounded-lg shadow-lg shadow-blue-500/30 object-contain bg-white">
                    <h1 class="font-bold text-lg">FleetDash</h1>
                </div>
                <button onclick="logout()" class="p-2 text-slate-400"><i data-lucide="log-out" class="w-6 h-6"></i></button>
            </header>

            <!-- DYNAMIC CONTENT CONTAINER -->
            <div id="app-content"></div>

        </main>
    </div>

    <!-- LOGIC -->
    <!-- SCRIPTS -->
    <script>
        const API_BASE = '/api/v1'; 
        const token = localStorage.getItem('access_token');
        
        // 1. Auth Check
        if(!token) window.location.href = '/';

        // 2. Load User Info
        const uName = localStorage.getItem('username') || 'User';
        // Default to 'user' if role is missing
        const uRole = (localStorage.getItem('user_role') || 'user').toLowerCase(); 
        
        document.getElementById('user-name').innerText = uName;
        document.getElementById('user-role').innerText = uRole.toUpperCase();
        document.getElementById('user-avatar').innerText = uName.charAt(0).toUpperCase();

        // 3. ROLE-BASED MENU CONFIGURATION
        const rolePermissions = {
            'admin':      ['all'], 
            'superadmin': ['all'],
            
            'charoi':     ['requests', 'panne', 'maintenance', 'reparations', 'fuel'],
            
            // Logistic sees Request & Trips
            'logistic':   ['requests'], 
            
            // Driver sees Trips & Requests
            'driver':     ['requests'],
            
            // Chef sees Requests
            'chef':       ['requests'],
            
            // Standard user only sees Requests
            'user':       ['requests'],

            // Operateur sees Requests & Fuel
            'operateur':  ['requests', 'fuel'],

            // Technicien sees Requests & Operations
            'technicien': ['requests', 'panne', 'maintenance', 'reparations'],
        };

        // 4. APPLY VISIBILITY
        function initSidebar() {
            // Get the list of allowed keys for this user
            const allowed = rolePermissions[uRole] || ['dashboard'];

            // Map HTML IDs to the keys above
            const menuMap = {
                'nav-dashboard':   'dashboard',
                'nav-analytics':   'analytics',
                'nav-vehicles':    'vehicles',
                'nav-requests':    'requests',
                'nav-users':       'users',
                'nav-maintenance': 'maintenance',
                'nav-panne':       'panne',
                'nav-reparations': 'reparations',
                'nav-fuel':        'fuel',
                'nav-trips':       'trips'
            };

            // Loop through all menu items and hide/show them
            for (const [elementId, permissionKey] of Object.entries(menuMap)) {
                const el = document.getElementById(elementId);
                if (!el) continue;

                if (allowed.includes('all') || allowed.includes(permissionKey)) {
                    el.style.display = 'flex'; // Show
                } else {
                    el.style.display = 'none'; // Hide
                }
            }
        }

        // 5. GLOBAL LOGOUT
        window.logout = function() {
            localStorage.clear();
            window.location.href = '/';
        }

        // Run Logic
        initSidebar();

    </script>

    <!-- Load Modules -->
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/vehicles.js"></script>
    <script src="/static/js/requests.js"></script>
    <script src="/static/js/users.js"></script>
    <script src="/static/js/fuel.js"></script>
    <script src="/static/js/maintenance.js"></script>
    <script src="/static/js/panne.js"></script>
    <script src="/static/js/reparation.js"></script>
    

    <!-- Load Router LAST -->
    <script src="/static/js/router.js"></script>
    
</body>
</html>